# ============================================================================
# PR Pipeline - Validate Pull Requests
# ============================================================================
# This workflow validates pull requests by running tests and building the
# container image WITHOUT deploying to Code Engine. It provides automated
# feedback on PR quality and build status.
#
# Prerequisites:
# 1. Dockerfile in repository root
# 2. GitHub Secrets configured: IBMCLOUD_API_KEY
# 3. GitHub Variables configured: IBMCLOUD_REGION, ICR_REGION, ICR_NAMESPACE,
#    RESOURCE_GROUP, PROJECT_NAME, APP_NAME, IMAGE_NAME
# 4. Code Engine project and ICR namespace created in IBM Cloud
# ============================================================================

name: Build and Test PR Code

# Trigger this workflow when PRs are opened/reopened or via manual dispatch
on:
  workflow_dispatch:  # Allows manual triggering from GitHub Actions UI
  pull_request:
    types: [opened, reopened]  # Runs when PR is opened or reopened

# Environment variables available to all jobs and steps in this workflow
env:
  GITHUB_SHA: ${{ github.sha }}                      # Git commit SHA for traceability
  IBMCLOUD_API_KEY: ${{ secrets.IBMCLOUD_API_KEY }}  # IBM Cloud authentication
  IBMCLOUD_REGION: ${{ vars.IBMCLOUD_REGION }}       # IBM Cloud region (e.g., us-south)
  RESOURCE_GROUP: ${{ vars.RESOURCE_GROUP }}         # IBM Cloud resource group
  ICR_NAMESPACE: ${{ vars.ICR_NAMESPACE }}           # Container Registry namespace
  ICR_REGION: ${{ vars.ICR_REGION }}                 # ICR hostname (e.g., us.icr.io)
  IMAGE_NAME: ${{ vars.IMAGE_NAME }}                 # Base container image name
  PROJECT_NAME: ${{ vars.PROJECT_NAME }}             # Code Engine project name
  APP_NAME: ${{ vars.APP_NAME }}                     # Code Engine application name
  MAX_PR_LINES: ${{ vars.MAX_PR_LINES || '1000' }}   # Maximum lines allowed in PR (default: 1000)

jobs:

  # Main PR validation job - tests and builds but does NOT deploy
  pr-pipeline:
    name: PR Pipeline
    runs-on: ubuntu-latest      # Use latest Ubuntu runner
    environment: production     # Uses production environment settings
    steps:

    # Step 1: Checkout the PR branch code
    # Uses GitHub's official checkout action to clone the PR branch
    - id: checkout-pr-code
      name: Checkout PR code
      uses: actions/checkout@v4

    # Step 2: Check PR size to encourage smaller, reviewable PRs
    # Uses custom composite action to validate PR size
    # Fails if PR has more than MAX_PR_LINES lines of changes (default: 1000)
    # Helps maintain code review quality and reduces merge conflicts
    - id: check-pr-size
      name: Check PR size
      uses: ./.github/actions/check-pr-size
      if: ${{ success() }}
      with:
        max_lines: ${{ env.MAX_PR_LINES }}
        github_token: ${{ github.token }}
    
    # Step 3: Set GitHub commit status to "pending"
    # Updates the PR's commit status in GitHub UI to show checks are running
    # Provides a link to the workflow run for detailed logs
    - id: set-commit-status-pending
      name: Set commit status (pending)
      uses: huayuenh/ghacatalog/set-commit-status@main  # Third-party action for status updates
      if: ${{ success() }}
      with:
        github_token: ${{ github.token }}                              # GitHub token for API access
        state: "pending"                                               # Status: pending, success, or failure
        description: "Running"                                         # Short description shown in PR
        context: "PR Pipeline"                                         # Name of the check in GitHub UI
        sha: ${{ github.sha }}                                         # Commit SHA to update
        target_url: "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"  # Link to workflow run
        github_repository: ${{ github.repository }}                    # Repository in owner/repo format

    # Step 4: Run unit tests on PR code
    # Installs dependencies and executes unit tests to validate code changes
    # Fails the workflow if tests don't pass, preventing merge of broken code
    - id: unit-test-pr-code
      name: Unit test PR code
      if: ${{ success() }}
      run: |
        npm install          # Install all npm dependencies
        npm run test-unit    # Run unit tests (must be defined in package.json)

    # Step 5: Build container image using Code Engine
    # Validates that the PR code can be successfully containerized
    # Image is tagged with "pr-" prefix to distinguish from CI builds
    # This is a temporary image that will be cleaned up after validation
    - id: build-pr-image
      name: Build PR image using Code Engine
      uses: IBM/code-engine-github-action@v1
      if: ${{ success() }}
      with:
        api-key: ${{ secrets.IBMCLOUD_API_KEY }}                    # IBM Cloud API key for authentication
        resource-group: ${{ vars.RESOURCE_GROUP }}                  # Target resource group
        region: ${{ vars.IBMCLOUD_REGION }}                         # IBM Cloud region
        project: ${{ vars.PROJECT_NAME }}                           # Code Engine project name
        component: 'build'                                          # Specifies this is a build operation
        name: 'build-pr-image'                                      # Name for the build configuration
        image: "private.${{ vars.ICR_REGION }}/${{ vars.ICR_NAMESPACE }}/pr-${{ vars.IMAGE_NAME }}:${{ github.sha }}"  # PR image path
        registry-secret: "ce-auto-icr-private-${{ vars.IBMCLOUD_REGION }}"  # Auto-generated registry secret
        build-source: './'                                          # Build context (current directory)

    # Step 6: Login to IBM Cloud CLI
    # Authenticates with IBM Cloud and installs Container Registry plugin
    # Required for subsequent image scanning and cleanup operations
    - id: login-ibmcloud-cli
      name: Login IBM Cloud CLI
      uses: IBM/actions-ibmcloud-cli@v1
      if: ${{ success() }}
      with:
        api_key: ${{ secrets.IBMCLOUD_API_KEY }}                # IBM Cloud API key for authentication
        region: ${{ vars.IBMCLOUD_REGION }}                     # IBM Cloud region
        group: ${{ vars.RESOURCE_GROUP }}                       # IBM Cloud resource group
        plugins: "container-registry"                           # Install Container Registry plugin

    # Step 7: Scan container image for vulnerabilities
    # Uses IBM Cloud Container Registry Vulnerability Advisor to scan for security issues
    # Checks for known CVEs, malware, and configuration issues
    # Waits for scan completion and displays results
    - id: scan-icr-pr-image
      name: Scan ICR PR image
      if: ${{ success() }}
      run: |
        # Get the image with digest and remove "private." prefix
        IMAGE_WITH_DIGEST="${{ steps.build-pr-image.outputs.image-with-digest }}"
        IMAGE_PATH="${IMAGE_WITH_DIGEST#private.}"

        echo "Scanning ICR image: $IMAGE_PATH"
        echo

        # Set the ICR region and login
        ibmcloud cr region-set "${ICR_REGION}"
        ibmcloud cr login
        
        # Initiate the vulnerability scan
        echo "Initiating vulnerability scan..."
        ibmcloud cr vulnerability-assessment "$IMAGE_PATH" || true
        
        # Wait for scan to complete (poll every 10 seconds, max 5 minutes)
        echo "Waiting for scan results..."
        MAX_ATTEMPTS=30
        ATTEMPT=0
        
        while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
          ATTEMPT=$((ATTEMPT + 1))
          echo "Checking scan status (attempt $ATTEMPT/$MAX_ATTEMPTS)..."
          
          # Check if scan is complete
          if ibmcloud cr vulnerability-assessment "$IMAGE_PATH" 2>&1 | grep -q "Scan complete"; then
            echo "Scan completed successfully!"
            break
          fi
          
          if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
            echo "WARNING: Scan did not complete within timeout period"
            break
          fi
          
          sleep 10
        done
        
        echo
        echo "=== Vulnerability Scan Results ==="
        ibmcloud cr vulnerability-assessment "$IMAGE_PATH"
        echo
        
        # Optional: Fail the build if critical vulnerabilities are found
        # Uncomment the following lines to enforce security policy
        # if ibmcloud cr vulnerability-assessment "$IMAGE_PATH" | grep -q "Critical"; then
        #   echo "ERROR: Critical vulnerabilities found in image"
        #   exit 1
        # fi

    # Step 8: Clean up temporary PR image from registry
    # Removes the temporary PR image from IBM Cloud Container Registry
    # Uses the digest to ensure we delete the exact image that was built
    # Checks for image existence before attempting removal
    # Important for keeping registry clean and reducing storage costs
    - id: remove-icr-pr-image
      name: Remove ICR PR image
      if: ${{ success() }}
      run: |
        # Get the image with digest from the build step output
        IMAGE_WITH_DIGEST="${{ steps.build-pr-image.outputs.image-with-digest }}"
        
        # Remove the "private." prefix if present
        IMAGE_WITH_DIGEST="${IMAGE_WITH_DIGEST#private.}"
        
        echo "Checking for ICR image: $IMAGE_WITH_DIGEST"
        
        # Check if the image exists before attempting to remove it
        if ibmcloud cr image-inspect "$IMAGE_WITH_DIGEST" &> /dev/null; then
          echo "Image found. Removing ICR image: $IMAGE_WITH_DIGEST"
          
          # Delete the image using the digest
          ibmcloud cr image-rm "$IMAGE_WITH_DIGEST"
          
          echo "Successfully removed PR image from registry"
        else
          echo "Image not found in registry. Skipping removal."
          echo "This may occur if the image was already deleted or the build failed."
        fi

    # Step 9a: Set GitHub commit status to "failure" if any step failed
    # Only runs if previous steps failed (if: failure() condition)
    # Updates PR status in GitHub UI to show checks failed
    # Provides link to workflow run for debugging
    - id: set-commit-status-fail
      name: Set commit status (fail)
      if: ${{ failure() }}  # Only runs if any previous step failed
      uses: huayuenh/ghacatalog/set-commit-status@main
      with:
        github_token: ${{ github.token }}                              # GitHub token for API access
        state: "failure"                                               # Status: failure
        description: "Complete - Failure"                              # Description shown in PR
        context: "PR Pipeline"                                         # Name of the check in GitHub UI
        sha: ${{ github.sha }}                                         # Commit SHA to update
        target_url: "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"  # Link to failed run
        github_repository: ${{ github.repository }}                    # Repository in owner/repo format

    # Step 9b: Set GitHub commit status to "success" if all steps passed
    # Only runs if all previous steps succeeded (if: success() condition)
    # Updates PR status in GitHub UI to show checks passed
    # Allows PR to be merged (if branch protection rules require this check)
    - id: set-commit-status-success
      name: Set commit status (success)
      if: ${{ success() }}  # Only runs if all previous steps succeeded
      uses: huayuenh/ghacatalog/set-commit-status@main
      with:
        github_token: ${{ github.token }}                              # GitHub token for API access
        state: "success"                                               # Status: success
        description: "Complete - Success"                              # Description shown in PR
        context: "PR Pipeline"                                         # Name of the check in GitHub UI
        sha: ${{ github.sha }}                                         # Commit SHA to update
        target_url: "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"  # Link to successful run
        github_repository: ${{ github.repository }}                    # Repository in owner/repo format